C51 COMPILER V9.54   UART                                                                  03/08/2017 15:17:00 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\output\uart.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE source\USER\uart\uart.c LARGE OPTIMIZE(0,SPEED) BROWSE MODC2 INCDIR(.\so
                    -urce\USER\A7139;.\source\USER\timer;.\source\USER\uart;.\source\USER\led;C:\Keil_v5\C51\INC\SONIX;.\source\USER\clock;.\
                    -source\USER\inc;.\source\USER\rtimer;.\source\USER\cmd) DEBUG OBJECTEXTEND PRINT(.\Listings\uart.lst) TABS(2) OBJECT(.\o
                    -utput\uart.obj)

line level    source

   1          
   2          #include "uart.h"
   3          
   4          xdata uint8_t RxBuf[UART_BUF_LEN_MAX] = {0};
   5          xdata uint8_t RxData = 0;
   6          xdata uint8_t UartRxFlag = 0;
   7          xdata uint8_t recv_head=0;
   8          xdata uint8_t recv_tail=0;
   9          
  10          //uart init
  11          void uart_init(void)
  12          {
  13   1        P05  = 1;     //UTX pin set high
  14   1        P0M |= 0x20;  //UTX is output,URX is input
  15   1        
  16   1        SM0 = 0;
  17   1        SM1 = 1;      //mode 1:8-bit uart
  18   1        REN0 = 1;     //uart reception enable
  19   1        
  20   1        switch (Baudrate) 
  21   1        {
  22   2              case BR_9600:
  23   2                  S0RELH = 0x03;
  24   2                  S0RELL = 0x98;      // for baudrate gen
  25   2      
  26   2                  PCON |= 0x80;       // SMOD = 1;    
  27   2                                      // baudrate : 9615
  28   2                  BD = 1;
  29   2                  break;
  30   2              case BR_19200:
  31   2                  S0RELH = 0x03;
  32   2                  S0RELL = 0xCC;      // for baudrate gen
  33   2      
  34   2                  PCON |= 0x80;       // SMOD = 1;    
  35   2                                      // baudrate : 19230
  36   2                  BD = 1;
  37   2                  break;
  38   2              case BR_38400:
  39   2                  S0RELH = 0x03;
  40   2                  S0RELL = 0xE6;      // for baudrate gen
  41   2      
  42   2                  PCON |= 0x80;       // SMOD = 1;    
  43   2                                      // baudrate : 38461
  44   2                  BD = 1;
  45   2                  break;
  46   2              case BR_57600:
  47   2                  S0RELH = 0x03;
  48   2                  S0RELL = 0xEF;      // for baudrate gen
  49   2      
  50   2                  PCON |= 0x80;       // SMOD = 1;    
  51   2                                      // baudrate : 58823
  52   2                  BD = 1;
C51 COMPILER V9.54   UART                                                                  03/08/2017 15:17:00 PAGE 2   

  53   2                  break;
  54   2              case BR_115200:
  55   2                  S0RELH = 0x03;
  56   2                  S0RELL = 0xF7;      // for baudrate gen
  57   2      
  58   2                  PCON |= 0x80;       // SMOD = 1;    
  59   2                                      // baudrate : 111111
  60   2                  BD = 1;
  61   2                  break;
  62   2              default:
  63   2                  // br_9600
  64   2                  S0RELH = 0x03;
  65   2                  S0RELL = 0x98;      // for baudrate gen
  66   2      
  67   2                  PCON |= 0x80;       // SMOD = 1;    
  68   2                                      // baudrate : 9615
  69   2                  BD = 1;
  70   2                  break;
  71   2        }
  72   1        
  73   1        ES0 = 1;   //enable uart interrupt
  74   1        EAL = 1;   //enable golbal interrupt
  75   1      }
  76          
  77          //uart interrupt function
  78          /*************************************************************************************
  79          uart接收命令帧格式（下行）
  80          起始字节 + 同步字节 + 节点地址 + 数据区（2个字节） + CRC校验码高字节 + CRC校验码低字节
  81          0xaa        0xbb      (1 -100)
  82          **************************************************************************************/
  83          void SYSUartInterrupt(void) interrupt ISRUart  // Vector @  0x23
  84          {
  85   1          if(RI0)
  86   1          {
  87   2              register uint8_t next = 0;
  88   2            
  89   2              RI0 = 0;                // Clear receiver flag
  90   2              RB80 = 0;
  91   2      
  92   2              next = (recv_head + 1) % UART_BUF_LEN_MAX;
  93   2              if( next != recv_tail )
  94   2              {
  95   3                  RxBuf[recv_head] = S0BUF;
  96   3                  recv_head = next;
  97   3              }
  98   2          }
  99   1      }
 100          
 101          //UART send one byte function
 102          void uart_send_byte(unsigned char txData)
 103          {
 104   1          S0BUF = txData;
 105   1      
 106   1          while(!TI0);       // wait for end of transmit
 107   1      
 108   1          if (TI0) 
 109   1          {
 110   2              TI0 = 0;
 111   2          }
 112   1      }
 113          //UART send string function
 114          void uart_send_string(unsigned char *s,unsigned char n)
C51 COMPILER V9.54   UART                                                                  03/08/2017 15:17:00 PAGE 3   

 115          {
 116   1         unsigned char idata i = 0;
 117   1         for(i=0;i<n;i++)
 118   1         {
 119   2          uart_send_byte(s[i]);
 120   2         }
 121   1      }
 122          //发送一个字符串
 123          void Prints(unsigned char *pd)
 124          {
 125   1        while((*pd) != '\0')
 126   1        {
 127   2          uart_send_byte(*pd);
 128   2          pd++;
 129   2        }
 130   1      }
 131          
 132          unsigned int Get_CRC_Check_Code(unsigned char *s,unsigned int n)
 133          {
 134   1       unsigned char idata i,j;
 135   1       unsigned int  idata CRC_Code = 0xFFFF;
 136   1       for(i=0;i<n;i++)
 137   1       {
 138   2           CRC_Code ^= s[i];
 139   2           for(j=0;j<8;j++)
 140   2           {
 141   3              if(CRC_Code&1)
 142   3              {
 143   4               CRC_Code >>= 1;
 144   4               CRC_Code ^= 0xA001;
 145   4              }
 146   3              else
 147   3              {
 148   4               CRC_Code >>= 1;
 149   4              }
 150   3           }
 151   2       }
 152   1       return CRC_Code;
 153   1      }
 154          
 155          
 156          void
 157          uart_writeb(char byte)
 158          {
 159   1          S0BUF = byte;
 160   1      
 161   1          while(!TI0);       // wait for end of transmit
 162   1      
 163   1          if (TI0) 
 164   1          {
 165   2              TI0 = 0;
 166   2          }
 167   1      }
 168          
 169          char
 170          putchar(char c)
 171          {
 172   1        uart_writeb((char) c);
 173   1        return c;
 174   1      }
 175          
 176          char getchar(void)
C51 COMPILER V9.54   UART                                                                  03/08/2017 15:17:00 PAGE 4   

 177          {
 178   1        register uint8_t p = 0;
 179   1        
 180   1        if(recv_tail != recv_head)
 181   1        {
 182   2            p = RxBuf[recv_tail];
 183   2            recv_tail = (recv_tail + 1) % UART_BUF_LEN_MAX;
 184   2        }
 185   1        
 186   1        return (char)p;
 187   1      }
 188          
 189          uint8_t avalible(void)
 190          {
 191   1        uint8_t cnt = 0;
 192   1        
 193   1        if(recv_tail < recv_head)
 194   1        {
 195   2           cnt = recv_head - recv_tail;
 196   2        }
 197   1        else if(recv_tail > recv_head)
 198   1        {
 199   2           cnt = UART_BUF_LEN_MAX - recv_tail + recv_head;
 200   2        }
 201   1        
 202   1        return cnt;
 203   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    791    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     54    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =      5    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
