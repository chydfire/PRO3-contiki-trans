C51 COMPILER V9.54   A7139_COMM                                                            03/09/2017 18:13:18 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE A7139_COMM
OBJECT MODULE PLACED IN .\output\A7139_comm.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE source\USER\A7139\A7139_comm.c LARGE OPTIMIZE(0,SPEED) BROWSE MODC2 INCD
                    -IR(.\source\USER\A7139;.\source\USER\timer;.\source\USER\uart;.\source\USER\led;C:\Keil_v5\C51\INC\SONIX;.\source\USER\c
                    -lock;.\source\USER\inc;.\source\USER\rtimer;.\source\USER\cmd) DEBUG OBJECTEXTEND PRINT(.\Listings\A7139_comm.lst) TABS(
                    -2) OBJECT(.\output\A7139_comm.obj)

line level    source

   1          #include "A7139_comm.h"
   2          #include "A7139.h"
   3          #include "SN8F5708.h"
   4          #include "uart.h"
   5          #include "led.h"
   6          #include "cmd.h"
   7          
   8          uint8_t idata rf_state_a7139 = RF_STATE_A7139_IDLE;
   9          uint8_t idata a7139_irq_status = 0;
  10          
  11          uint16_t idata crc_check_code = 0;
  12          uint8_t idata crc_check_code_l = 0;
  13          uint8_t idata crc_check_code_h = 0;
  14          
  15          
  16          uint8_t idata bufSend[]=  {"A7139"};
  17          uint8_t xdata bufRecv[RF_RECV_BUF_LEN_MAX]={0};
  18          
  19          uint8_t idata string_test[] = {"hellow !"};
  20          uint8_t idata i = 0;
  21          
  22          extern uint8_t idata UartRxFlag;
  23          extern uint8_t idata RxBuf[RF_RECV_BUF_LEN_MAX];
  24          uint8_t xdata a7139_tx[RF_RECV_BUF_LEN_MAX]={0};
  25          
  26          extern uint8_t xdata per_second_flag;
  27          extern xdata uint8_t rf_tx_valid_flag;
  28          
  29          xdata uint8_t rf_retx_valid_flag = 0;
  30          
  31          //定义二维数组，存放向各节点要发送的数据，注意第3字节为节点地址，节点接收到数据后需比对节点地址
  32           uint8_t xdata slave_cmd[10][RF_RECV_BUF_LEN_MAX] = {{0xaa,0xbb,0x01,0x00,0x00,0x3c,0x49},
  33                                       {0xaa,0xbb,0x02,0x00,0x00,0x3c,0xb9},
  34                                       {0xaa,0xbb,0x03,0x00,0x00,0xfc,0xe8},
  35                                       {0xaa,0xbb,0x04,0x00,0x00,0x3d,0x59},
  36                                       {0xaa,0xbb,0x05,0x00,0x00,0xfd,0x08},
  37                                       {0xaa,0xbb,0x06,0x00,0x00,0xfd,0xf8},
  38                                       {0xaa,0xbb,0x07,0x00,0x00,0x3d,0xa9},
  39                                       {0xaa,0xbb,0x08,0x00,0x00,0x3e,0x99},
  40                                       {0xaa,0xbb,0x09,0x00,0x00,0xfe,0xc8},
  41                                       {0xaa,0xbb,0x0a,0x00,0x00,0xfe,0x38}};
  42           
  43                                       
  44          //INT1 interrupt function
  45          void INT1Interrupt(void) interrupt ISRInt1 //
  46          { //IE0 clear by hardware
  47   1        a7139_irq_status = 1; 
  48   1      }
  49          
  50          //a7139 transmit a packet
  51          void a7139_tx_packet(uint8_t *s,uint8_t n)
  52          {
C51 COMPILER V9.54   A7139_COMM                                                            03/09/2017 18:13:18 PAGE 2   

  53   1          A7139_StrobeCmd(CMD_STBY);
  54   1          delay_ms(10);
  55   1          //send a tx packet
  56   1      //    A7139_WriteFIFO(s,7);
  57   1          A7139_WriteFIFO(s,n);
  58   1          A7139_StrobeCmd(CMD_TX);
  59   1          delay_ms(10);//For some perform faster MCU, need time to wait at least more than 10 millisecond
  60   1          rf_state_a7139 =  RF_STATE_A7139_TX;
  61   1      }
  62          uint8_t chkSumCalc( const uint8_t * pData, uint8_t len )
  63          {
  64   1          uint8_t chksum = 0;
  65   1          uint8_t i = 0;
  66   1      
  67   1          for( i = 0; i < len; i++ )
  68   1          {
  69   2              chksum += pData[i];
  70   2          }
  71   1      
  72   1          chksum = ~chksum + 1;
  73   1          return chksum;
  74   1      }
  75          int a7139_master()
  76          {
  77   1          int ret = TRUE;
  78   1          uint8_t rx_tmp = 0;
  79   1      //    static int i = 0;
  80   1      //     uint8_t tmp[RF_RECV_BUF_LEN_MAX] = {0xaa,0x07,0x0a,0x00,0x01,0x02,0x03,0x04,0x05,0xE0};
  81   1        
  82   1          //send a tx packet per 100ms
  83   1      //     if(per_second_flag == 1)
  84   1      //     {
  85   1      //       per_second_flag = 0;
  86   1      //         a7139_tx_packet(tmp,RF_RECV_BUF_LEN_MAX);
  87   1      //       if(i < 10)
  88   1      //       {
  89   1      //          a7139_tx_packet(slave_cmd[i],RF_RECV_BUF_LEN_MAX);
  90   1      //          i++;
  91   1      //       }
  92   1      //       else
  93   1      //       {
  94   1      //          i = 0;
  95   1      //       }
  96   1      //     }
  97   1           //A7139 interrupt
  98   1           if(a7139_irq_status == 1)
  99   1           {
 100   2            switch(rf_state_a7139)
 101   2            {
 102   3              case RF_STATE_A7139_IDLE:
 103   3                A7139_ReadFIFO(bufRecv,sizeof(bufSend));
 104   3                A7139_StrobeCmd(CMD_RX);
 105   3                rf_state_a7139 = RF_STATE_A7139_RX;
 106   3                break;
 107   3              case RF_STATE_A7139_RX:
 108   3                A7139_ReadFIFO(bufRecv,sizeof(bufRecv));
 109   3                A7139_StrobeCmd(CMD_RX);                
 110   3              
 111   3                if(bufRecv[bufRecv[1]+2]==chkSumCalc(&bufRecv[1],bufRecv[1]+1))  //CRC 校验,高字节在前
 112   3                { 
 113   4                  if(bufRecv[2] == 0x0a)//节点地址
 114   4                  {
C51 COMPILER V9.54   A7139_COMM                                                            03/09/2017 18:13:18 PAGE 3   

 115   5                    uart_send_string1(bufRecv,bufRecv[1]+3);//debug 
 116   5                    toggle_led_red;
 117   5                  }
 118   4                  else
 119   4                  {
 120   5                    if(bufRecv[3])
 121   5                    {
 122   6                      bufRecv[3]--;
 123   6                      bufRecv[bufRecv[1]+2]++;
 124   6                      rf_retx_valid_flag=1;
 125   6                    }
 126   5                  }
 127   4                }
 128   3                break;
 129   3              case RF_STATE_A7139_TX:
 130   3                //tx completed
 131   3                blink_led_blue;//debug      
 132   3                A7139_StrobeCmd(CMD_RX); //enter RX 
 133   3                delay_ms(10);//For some perform faster MCU, need time to wait at least more than 10 millisecond
 134   3                rf_state_a7139 = RF_STATE_A7139_RX;       
 135   3                break;
 136   3            }
 137   2      
 138   2            a7139_irq_status = 0;
 139   2           }
 140   1           if(rf_retx_valid_flag)
 141   1          {
 142   2            clock_delay_ms(1000);
 143   2            a7139_tx_packet(bufRecv,bufRecv[1]+3);
 144   2            rf_retx_valid_flag = 0;
 145   2          }
 146   1           
 147   1           //uart received a packet
 148   1           if(rf_tx_valid_flag == 1)
 149   1           {
 150   2             a7139_tx_packet(a7139_tx,a7139_tx[1]+3);
 151   2             
 152   2             rf_tx_valid_flag = 0;
 153   2           }
 154   1         return ret;
 155   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    488    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    494    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     22    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
